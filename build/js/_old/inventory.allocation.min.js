$(function(){var d=0,j=0,a=0;$("#tr_date").inputmask("9999-99-99",{placeholder:"yyyy-mm-dd"});$("select#tr_location, select#tr_funding, select#tr_program").change(function(){if($("select#tr_location").val()!=""&&$("select#tr_funding").val()!=""){h()}else{f()}});$("#medicine").change(function(){if($("select#tr_location").val()!=""&&$("select#tr_funding").val()!=""&&$("#medicine").val()!=""){c()}else{f()}});$("select#tr_lot_no").change(function(){if($("select#tr_location").val()!=""&&$("select#tr_funding").val()!=""&&$("#medicine").val()!=""&&$("#tr_lot_no").val()!=""){f();g()}if($("#tr_lot_no").val()==""){$("#unit, #tr_qty").prop("disabled",false);$("select#unit option").detach();$("#unit").append('<option value="">- - -</option>');$("#unit, #tr_qty").prop("disabled",true);$("span.remarks").html("")}});$("#tr_location").change(function(){$("select#tr_destination option").detach();$("#tr_destination").append('<option value="">- - -</option>');$("#tr_destination").append('<option value="ABTC">ABTC</option>');$("#tr_destination").append('<option value="ALASAS STORAGE">ALASAS STORAGE</option>');$("#tr_destination").append('<option value="BS 1 - SINDALAN">BS 1 - SINDALAN</option>');$("#tr_destination").append('<option value="BS 2 - NORTHVILLE">BS 2 - NORTHVILLE</option>');$("#tr_destination").append('<option value="BS 3 - SAN JOSE">BS 3 - SAN JOSE</option>');$("#tr_destination").append('<option value="BS 4 - SAN NICOLAS">BS 4 - SAN NICOLAS</option>');$("#tr_destination").append('<option value="BS 5 - SAN AGUSTIN">BS 5 - SAN AGUSTIN</option>');$("#tr_destination").append('<option value="CHO MAIN">CHO MAIN</option>');$("#tr_destination").append('<option value="CITY COLLEGE">CITY COLLEGE</option>');$("#tr_destination").append('<option value="NORTHVILLE STORAGE">NORTHVILLE STORAGE</option>');$("#tr_destination").append('<option value="RHU 1">RHU 1</option>');$("#tr_destination").append('<option value="RHU 2">RHU 2</option>');$("#tr_destination").append('<option value="RHU 3">RHU 3</option>');$("#tr_destination").append('<option value="RHU 4">RHU 4</option>');$("#tr_destination").append('<option value="RHU 5">RHU 5</option>');$("#tr_destination").append('<option value="HEMS">HEMS</option>');$("#tr_destination").append('<option value="EHSD">EHSD</option>');$("#tr_destination").append('<option value="SOCIAL HYGIENE">SOCIAL HYGIENE</option>');var l=$("select#tr_location").find("option:selected");$("#tr_destination option[value='"+l.val()+"']").remove()});$("#tr_qty").focusout(function(){if(Number($(this).val())==""){$(this).val(0)}});function g(){console.log("search_medicine");$("#tr_qty").val(Number($("#tr_qty1").val()));f();var l={tr_location:$("#tr_location").val(),tr_funding:$("#tr_funding").val(),tr_lot_no:$("#tr_lot_no").val(),medicine:$("#medicine").val(),tr_program:$("#tr_program").val()};$.ajax({dataType:"json",type:"GET",url:base_url+"admin/ajax_search",data:l,beforeSend:function(){$("#unit, #tr_qty").prop("disabled",false);$("select#unit option").detach();$("#unit").append('<option value="">- - -</option>');$("#unit, #tr_qty").prop("disabled",true)},success:function(m){if(m.status=="no"){}else{d=m[0].box;j=m[0].pcs;a=m[0].pcsper_set_x_qty;$("#tr_lot_no").attr("data-box",d);$("#unit").prop("disabled",false)}},error:function(o,m,n){e("Search Medicine - Error!","Connection problems occurred... Unable to connect to the Internet! The Internet connection has been lost. ","error",1500)}});return false}function h(){console.log("get_medicine");$("#tr_qty").val(Number($("#tr_qty1").val()));f();var l={tr_location:$("#tr_location").val(),tr_funding:$("#tr_funding").val(),tr_program:$("#tr_program").val(),medicine:""};$.ajax({dataType:"json",type:"GET",url:base_url+"admin/ajax_search",data:l,beforeSend:function(){$("#medicine").append('<option value="">loading...</option>')},success:function(m){$("#medicine option").detach();if(m.status=="no"){$("sup.r").text("No Available Stock");$("#mdl-popup .modal-body p:eq(0) span").text($("#tr_location").val());$("#mdl-popup .modal-body p:eq(1) span").text($("#tr_funding").val());$("#mdl-popup .modal-body p:eq(2) span").text($("#tr_program").val());$("#mdl-popup").modal("show");$("#tr_lot_no option, #unit option").detach();$("#tr_lot_no, #unit").append('<option value="">- - -</option>');$("#medicine, #tr_lot_no, #unit, #tr_qty").prop("disabled",true)}else{$("sup.r").text("");$("#medicine").prop("disabled",false);$.each(m,function(n,o){if(o.pcsper_set_x_qty!=0){$("#medicine").append("<option value="+o.m_id+" data-m_name='"+o.m_name+"' data-tr_si_no='"+o.tr_si_no+"' data-tr_dr_no='"+o.tr_dr_no+"' data-tr_supplier='"+o.tr_supplier+"'>"+o.m_name+"</option>")}});$("#medicine").val(null).trigger("change")}},error:function(o,m,n){e("Search Medicine - Error!","Connection problems occurred... Unable to connect to the Internet! The Internet connection has been lost. ","error",1500)}});return false}function c(){console.log("get_lotno");$("#tr_qty").val(Number($("#tr_qty1").val()));f();var l={tr_location:$("#tr_location").val(),tr_funding:$("#tr_funding").val(),medicine:$("#medicine").val(),tr_program:$("#tr_program").val(),tr_lot_no:""};$.ajax({dataType:"json",type:"GET",url:base_url+"admin/ajax_search",data:l,beforeSend:function(){$("#tr_lot_no option").detach();$("#tr_lot_no").append('<option value="">loading...</option>');$("#tr_lot_no, #unit, #tr_qty").prop("disabled",true)},success:function(m){if(m.status=="no"){$("#tr_qty").prop("disabled",true)}else{$("#tr_lot_no").prop("disabled",false);$("#tr_lot_no option").detach();$("#tr_lot_no").append('<option value="">- - -</option>');$("#tr_lot_no").prop("disabled",false);$.each(m,function(p,w){if(w.pcsper_set_x_qty!=0){var r=new Date(w.tr_expiration_date),q=r.getDate(),t=r.getMonth()+1,x=r.getFullYear(),o=x.toString().substring(2,4);$("#tr_lot_no").append("<option value='"+w.tr_lot_no+"' data-m_name='"+w.m_name+"' data-m_set='"+w.m_set+"' data-pcsper_set="+w.m_pcsper_set+" data-program='"+w.tr_program+"' data-expirationdate='"+w.tr_expiration_date+"' style='color:"+w.remarks+"'>"+w.tr_lot_no+" ["+t+"."+q+"."+o+"]</option>");var u=$("input[name^='vlotno']").length,s=$("input[name^='vlotno']");for(i=0;i<u;i++){var v=s.eq(i).attr("value");$("#tr_lot_no option[value='"+v+"']").remove()}}})}},error:function(o,m,n){e("Search LotNo. - Error!","Connection problems occurred... Unable to connect to the Internet! The Internet connection has been lost. ","error",1500)}});return false}$("select#unit").focus(function(){var o=$("#tr_lot_no").find("option:selected");var n=o.data("m_set"),m=o.data("pcsper_set"),l=$("#tr_lot_no").attr("data-box");$("select#unit option").detach();if(o.val()!=""){$("#unit").append('<option value="">- - -</option>');if(l!="0"){$("select#unit").append('<option value="'+m+'" data-val="'+n+" ["+m+']" data-unit="'+n+'">'+n+" ["+m+"]</option>")}if(m!=1){$("select#unit").append('<option value="1" data-val="PC [1]" data-unit="PC">PC [1]</option>')}}});$("select#unit").change(function(){$("#tr_qty1, #tr_qty").val("");var m=$(this).find("option:selected"),l=m.data("unit");if(m.val()!=""){$("#tr_qty").prop("disabled",false);if(l=="PC"){if(a=="0"){$("#tr_qty1").val("0");$("span.remarks").html("0")}else{$("#tr_qty1").val(a);$("span.remarks").html(" ["+a+" PC/s]")}}else{if(d=="0"){if(j=="0"){$("#tr_qty1").val("0");$("span.remarks").html("0")}else{$("#tr_qty1").val(j);$("span.remarks").html(" ["+j+" PC/s]")}}else{$("#tr_qty1").val(d);if(j=="0"){$("span.remarks").html(" ["+d+" "+l+"/es ]")}else{$("span.remarks").html(" ["+d+" "+l+"/es & "+j+" PC/s]")}}}}else{$("span.remarks").html("");$("#tr_qty").prop("disabled",true)}});$("#frm_allocation").formValidation({framework:"bootstrap",icon:null,fields:{tr_allocateby:{validators:{regexp:{regexp:/^[0-9a-zA-Z .,-]+$/i}}},tr_by:{validators:{regexp:{regexp:/^[0-9a-zA-Z .,-]+$/i}}},tr_rs_no:{validators:{regexp:{regexp:/^[0-9a-zA-Z .,-]+$/i}}},tr_qty:{validators:{lessThan:{value:"tr_qty1",message:"The value must be less than or equal to Qty [ - -]"}}},tr_date:{validators:{date:{format:"YYYY-MM-DD",message:"The value is not a valid date"}}}}}).on("success.form.fv",function(l){if($(".tbl-medicine-container #tbl_medicine tbody > tr .m-delete").length==0){e("Required *","Please add medicine","",1500);return false}l.preventDefault();var r=$(l.target),o=r.data("formValidation").getSubmitButton();switch(o.attr("id")){case"btn_frm_allocation":$("#tr_location, #tr_funding, #tr_program").prop("disabled",false);$("#mdl-save-draft .btn-close").trigger("click");var q=new Date(),n=("0"+(q.getMonth()+1)).slice(-2),m=q.getFullYear().toString().substr(2,2);q="A-"+m+""+n;var p={format:q};$.ajax({dataType:"json",type:"GET",url:base_url+"inventory/ajax_search_risno",data:p,beforeSend:function(){e("Processing","Please wait..","info",999999)},success:function(s){$(".alert-info .glyphicon-remove").trigger("click");if(s.status=="no"){$("#tr_rs_no").val(q+"-0001")}else{$("#tr_rs_no").val(q+"-"+s[0].series)}$.ajax({dataType:"json",type:"post",url:base_url+"inventory/ajax_saveallocation",data:$("#frm_allocation").serialize(),beforeSend:function(){e("Processing","Please wait..","info",999999)},success:function(t){$(".alert-info .glyphicon-remove").trigger("click");if(t.status=="yes"){e("Success!",t.content,"success",1500);$("#mdl-print").modal("show")}else{e("Failed!",t.content,"",1500);b()}},error:function(v,t,u){$(".alert-info .glyphicon-remove").trigger("click");if(v.responseText.indexOf("1062")!=-1){e("Duplicate entry!","This medicine is already exists!, Please check.","error",1500)}else{e("Error!","Connection problems occurred... Unable to connect to the Internet! The Internet connection has been lost.","error",1500)}b()}})},error:function(u,s,t){$(".alert-info .glyphicon-remove").trigger("click");e("Error!","Connection problems occurred... Unable to connect to the Internet! The Internet connection has been lost.","error",1500);b()}});break;case"draftButton":$("#mdl-save-draft .modal-body p:eq(0)").text($("#tr_location").val());$("#mdl-save-draft .modal-body p:eq(1)").text($("#tr_funding").val());$("#mdl-save-draft .modal-body p:eq(2)").text($("#tr_program").find("option:selected").text());$("#mdl-save-draft .modal-body p:eq(3)").text($("#tr_destination").val());$("#mdl-save-draft .modal-body p:eq(4)").text($("#tr_by").val());$("#mdl-save-draft .modal-body p:eq(5)").text($("#tr_allocateby").val());$("#mdl-save-draft .modal-body p:eq(6)").text($("#tr_date").val());$("#mdl-save-draft .modal-body p:eq(7)").text($("#tr_rs_no").val());$("#mdl-save-draft .draft-table").empty();$("#tbl_medicine").clone().appendTo("#mdl-save-draft .modal-body .draft-table");$(".draft-table #tbl_medicine input").removeAttr("name");$(".draft-table #tbl_medicine input").removeAttr("id");r.data("formValidation").disableSubmitButtons(false);$("#mdl-save-draft").modal("show");break}return false});$("body").delegate("#btn_add_medicine","click",function(){if($("body .ui-pnotify > .alert-warning").length==0){if($("select#medicine").val()==""||$("select#medicine").val()==null){e("Required *","Please select medicine","",1500);$("select#medicine").focus();$form.data("formValidation").disableSubmitButtons(false);return false}if($("select#tr_lot_no").val()==""){e("Required *","Please select lot no.","",1500);$("select#tr_lot_no").focus();$form.data("formValidation").disableSubmitButtons(false);return false}if($("select#unit").val()==""){e("Required *","Please select package","",1500);$("select#unit").focus();$form.data("formValidation").disableSubmitButtons(false);return false}if($("#tr_qty").val()=="0"||$("#tr_qty").val()==""||$(".form-group-add").hasClass("has-error")){e("Required *","Please check the qty","",1500);$("#tr_qty").focus();$form.data("formValidation").disableSubmitButtons(false);return false}$("#tbl_medicine").removeClass("display-none");var n=$("select#medicine").find("option:selected"),x=n.data("m_name"),w=n.data("tr_si_no"),y=n.data("tr_dr_no"),o=n.data("tr_supplier");var p=$("select#tr_lot_no").find("option:selected"),m=p.val();var s=$("select#unit").find("option:selected"),v=s.data("val"),A=s.data("unit"),z=s.val(),l=$("#tr_qty").val();var t=$("select#tr_lot_no").find("option:selected"),q=t.data("program"),u=t.data("expirationdate");$("#tr_qty1").val(Number($("#tr_qty1").val())-Number(l));var r=$('<tr><td class="m-delete text-center" data-qty="'+l+'"><a class="close-link"><i class="fa fa-close"></i></a></td><td><input type="hidden" name="vmedicine[]" data-name="'+x+'" value="'+$("select#medicine").val()+'"/>'+x+'</td><td><input type="hidden" name="m_tr_si_no[]" value="'+w+'"/><input type="hidden" name="m_tr_dr_no[]" value="'+y+'"/><input type="hidden" name="m_tr_supplier[]" value="'+o+'"/><input type="hidden" name="vexpirationdate[]" value="'+u+'"/><input type="hidden" name="vlotno[]" value="'+m+'"/>'+m+'</td><td><input type="hidden" name="vunit[]" value="'+A+'"/><input type="hidden" name="vpcsper_set[]" value="'+z+'"/>'+v+'</td><td class="text-right"><input type="hidden" name="vqty[]" value="'+l+'"/>'+l+"</td></tr>");$("#tbl_medicine").append(r);$("#unit").val("").trigger("change");$(".form-group-add").removeClass("has-success");$(".form-group-add").removeClass("has-error");$("#tr_qty").val("");$("#tr_location, #tr_funding, #tr_program").prop("disabled",true);$("#btn_cancel_trans").removeClass("hidden");$("#tr_lot_no").find("option:selected").remove()}});$("body").delegate(".m-delete","click",function(){$("#tr_qty1").val(Number($(this).data("qty"))+Number($("#tr_qty1").val()));$(this).parent().remove();$("#medicine").val(null).trigger("change")});$("body").delegate("#btn_cancel_trans","click",function(){$("#tr_location, #tr_funding, #tr_program").prop("disabled",false);$("#tr_location, #tr_funding").val("");$("#tr_program").val("N/A");$("#btn_cancel_trans").addClass("hidden");$("#frm_allocation").data("formValidation").resetForm();$("#medicine, #tr_lot_no, #unit, #tr_qty").prop("disabled",true);$("#tbl_medicine").addClass("display-none");$("#tbl_medicine tbody").detach();$("span.remarks").html("");f()});$("body").delegate("#btn_cancel","click",function(){b()});function e(m,n,o,l){new PNotify({title:m,text:n,styling:"bootstrap3",type:o,delay:l})}function b(){$("#btn_cancel_trans").addClass("hidden");$("#tr_location, #tr_funding, #tr_program").prop("disabled",false);$("#frm_allocation").data("formValidation").resetForm();$("#frm_allocation")[0].reset();$("#medicine, #tr_lot_no, #unit, #tr_qty").prop("disabled",true);$("#tbl_medicine").addClass("display-none");$("#tbl_medicine tbody").detach();$("span.remarks").html("");f()}function f(){d=0;j=0;a=0;$("#tr_qty, #unit, #tr_qty1").val("");$("span.remarks").html("")}function k(p,o,l,n){var m=new XMLHttpRequest();m.open("GET",p,true);m.onreadystatechange=function(){if(this.readyState==4&&this.status==200){var q=JSON.parse(this.responseText);$(o).detach();if(n==0){$(l).append('<option value="">ALL</option>')}else{$(l).append("<option value='N/A'>N/A</option>")}for(i=0;i<q.length;i++){$(l).append("<option value='"+q[i].value+"'>"+q[i].value+"</option>")}$(l).prop("disabled",false)}};m.send()}k(base_url+"admin/ajax_get_tr_location","#tr_location option","#tr_location",0);k(base_url+"admin/ajax_get_tr_funding","#tr_funding option","#tr_funding",0);k(base_url+"admin/ajax_get_program","#tr_program option","#tr_program",1);$("body").delegate("#btn_cancel_print","click",function(){b()});$("body").delegate("#btn_print","click",function(){$(".glyphicon-remove").trigger("click");$("span.source").text($("#tr_location").val());$("span.destination").text($("#tr_destination").val());var r=new Date($("#tr_date").val().split("-")),o=r.getDate(),m=r.getMonth()+1,w=r.getFullYear();r=m+"/"+o+"/"+w;$("span.date").text(r);$("span.tr_by").text($("#tr_by").val());$("span.tr_allocateby").text($("#tr_allocateby").val());$("span.tr_recvby").text($("#tr_by").val());$("div.p_risno").text($("#tr_rs_no").val());var v=$("input[name^='vmedicine']").length,p=$("input[name^='vmedicine']"),q=$("input[name^='vlotno']"),l=$("input[name^='vunit']"),u=$("input[name^='vpcsper_set']"),t=$("input[name^='vqty']"),s=$("input[name^='vexpirationdate']");$("#tbl-print .t-detach").detach();for(i=0;i<v;i++){var r=new Date(s.eq(i).attr("value").split("-")),o=r.getDate(),m=r.getMonth()+1,w=r.getFullYear();r=m+"/"+o+"/"+w;$("#tbl-print tr.title").after("<tr class='t-detach'><td>&nbsp; "+r+"</td><td colspan='2'> &nbsp;"+p.eq(i).attr("data-name")+" ["+q.eq(i).attr("value")+"]</td><td>&nbsp; "+u.eq(i).attr("value")+" ["+l.eq(i).attr("value")+"]</td><td class='text-right'>"+t.eq(i).attr("value")+"&nbsp;</td><td colspan='2'></td></tr>")}$("#mdl-previewprint").modal("show");b()})});function printContent(b){var a=document.getElementById(b);newWin=window.open("");newWin.document.write("<html><head><style>table{width:100%}b, strong {font-weight:700}table {border-collapse:collapse;}table td, table th{ border: 1px solid black; text-align:left;}tr.group{background-color: #d8d8d8;margin-top:10px;padding-top:10px} .img-logo {position:absolute;left:calc(50% - 200px);top:11px}.th-head{position:relative;padding:10px 0}p.p-version{position:absolute;top:0;right:3px;font-size:9px}.version{position:relative}.p_risno{position:absolute;right:6px;top:3px}.text-right{text-align:right}</style>");newWin.document.write('</head><body onload="window.print()">');newWin.document.write(a.outerHTML);newWin.document.write("</body>");newWin.document.write("</html>");newWin.print();newWin.close()};