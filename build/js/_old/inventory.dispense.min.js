$(function(){var o=0,d=0,k=0;$("#tr_date").inputmask("9999-99-99",{placeholder:"yyyy-mm-dd"});var l=$("#tr_brgy");var m=new Array,b=new XMLHttpRequest();b.open("GET",base_url+"inventory/ajax_get_name",true);b.onreadystatechange=function(){if(this.readyState==4&&this.status==200){var q=JSON.parse(this.responseText);for(i=0;i<q.length;i++){m.push({fullname:q[i].fullname,lastname:q[i].tr_lname,firstname:q[i].tr_fname})}}};b.send();var h={data:m,getValue:"firstname",highlightPhrase:true,template:{type:"custom",method:function(r,q){return q.firstname+" "+q.lastname}},list:{match:{enabled:true},onSelectItemEvent:function(){var q=$("#tr_fname").getSelectedItemData().lastname;$("#tr_lname").val(q).trigger("change")}}};$("#tr_fname").easyAutocomplete(h);$("#tr_type").change(function(){p()});function p(){if($("#tr_type").val()=="CITY-EMPLOYEE"){$(".lbl-bgry").html("Department <span>*</span>");$("select#tr_brgy option").detach();l.append('<option value=\'BFP\'>BFP</option><option value=\'CITY ACCOUNTANTS OFFICE\'>CITY ACCOUNTANT\'S OFFICE</option><option value=\'CITY ADMINISTRATORS OFFICE\'>CITY ADMINISTRATOR\'S OFFICE</option><option value="CITY AGRICULTURE AND VETERINARY OFFICE">CITY AGRICULTURE AND VETERINARY OFFICE</option><option value="CITY BUDGET OFFICE">CITY BUDGET OFFICE</option><option value="CITY CIVIL REGISTRY OFFICE">CITY CIVIL REGISTRY OFFICE</option><option value="CITY COLLEGE">CITY COLLEGE</option><option value="CITY DISASTER AND RISK REDUCTION">CITY DISASTER AND RISK REDUCTION</option><option value=\'CITY ENGINEERS OFFICE\'>CITY ENGINEER\'S OFFICE</option><option value="CITY ENVIRONMENT AND NATURAL RESOURCES OFFICE">CITY ENVIRONMENT AND NATURAL RESOURCES OFFICE</option><option value="CITY GENERAL SERVICES OFFICE">CITY GENERAL SERVICES OFFICE</option><option value="CITY HEALTH OFFICE">CITY HEALTH OFFICE</option><option value="CITY HUMAN RESOURCE DEVELOPMENT OFFICE">CITY HUMAN RESOURCE DEVELOPMENT OFFICE</option><option value="CITY INVESTMENT PROMOTION OFFICE">CITY INVESTMENT PROMOTION OFFICE</option><option value="CITY LEGAL OFFICE">CITY LEGAL OFFICE</option><option value=\'CITY MAYORS OFFICE\'>CITY MAYOR\'S OFFICE</option><option value=\'CITY PLANNING AND DEVELOPMENT COORDINATORS OFFICE\'>CITY PLANNING AND DEVELOPMENT COORDINATOR\'S OFFICE</option><option value="CITY SOCIAL WELFARE DEVELOPMENT OFFICE">CITY SOCIAL WELFARE DEVELOPMENT OFFICE</option><option value="CITY TOURISM AND INVESTMENT PROMOTION OFFICE">CITY TOURISM AND INVESTMENT PROMOTION OFFICE</option><option value=\'CITY TREASURERS OFFICE\'>CITY TREASURER\'S OFFICE</option><option value="DEPARTMENT OF EDUCATION">DEPARTMENT OF EDUCATION</option><option value="OFFICE OF THE CITY VICE MAYOR">OFFICE OF THE CITY VICE MAYOR</option><option value="OFFICE OF THE SANGGUNIANG PANLUNGSOD">OFFICE OF THE SANGGUNIANG PANLUNGSOD</option><option value="PNP">PNP</option><option value="POSCO">POSCO</option>')}else{$(".lbl-bgry").html("Brgy <span>*</span>");$("select#tr_brgy option").detach();l.append('<option value="">- - -</option><option value="Alasas">Alasas</option><option value="Baliti">Baliti</option><option value="Bulaon">Bulaon</option><option value="Calulut">Calulut</option><option value="Dela Paz Norte">Dela Paz Norte</option><option value="Dela Paz Sur">Dela Paz Sur</option><option value="Del Carmen">Del Carmen</option><option value="Del Pilar">Del Pilar</option><option value="Del Rosario">Del Rosario</option><option value="Dolores">Dolores</option><option value="Juliana">Juliana</option><option value="Lara">Lara</option><option value="Lourdes">Lourdes</option><option value="Maimpis">Maimpis</option><option value="Magliman">Magliman</option><option value="Malino">Malino</option><option value="Malpitic">Malpitic</option><option value="Pandaras">Pandaras</option><option value="Panipuan">Panipuan</option><option value="Pulung Bulo">Pulung Bulo</option><option value="Quebiawan">Quebiawan</option><option value="Saguin">Saguin</option><option value="San Agustin">San Agustin</option><option value="San Felipe">San Felipe</option><option value="San Isidro">San Isidro</option><option value="San Jose">San Jose</option><option value="San Juan">San Juan</option><option value="San Nicolas">San Nicolas</option><option value="San Pedro Cutud">San Pedro Cutud</option><option value="Santa Lucia">Santa Lucia</option><option value="Santa Teresita">Santa Teresita</option><option value="Santo Nino">Santo Nino</option><option value="Santo Rosario">Santo Rosario</option><option value="Sindalan">Sindalan</option><option value="Telabastagan">Telabastagan</option>')}}$("select#tr_funding, select#tr_program").change(function(){if($("select#tr_funding").val()!=""){a()}else{j()}});$("#medicine").change(function(){if($("select#tr_funding").val()!=""&&$("#medicine").val()!=""){f()}else{j()}});$("select#tr_lot_no").change(function(){if($("select#tr_funding").val()!=""&&$("#medicine").val()!=""&&$("#tr_lot_no").val()!=""){j();n()}if($("#tr_lot_no").val()==""){$("#unit, #tr_qty").prop("disabled",false);$("select#unit option").detach();$("#unit").append('<option value="">- - -</option>');$("#unit, #tr_qty").prop("disabled",true);$("span.remarks").html("")}});$("#tr_qty").focusout(function(){if(Number($(this).val())==""){$(this).val(0)}});function n(){console.log("search_medicine");$("#tr_qty").val(Number($("#tr_qty1").val()));j();var q={tr_funding:$("#tr_funding").val(),tr_lot_no:$("#tr_lot_no").val(),medicine:$("#medicine").val(),tr_program:$("#tr_program").val()};$.ajax({dataType:"json",type:"GET",url:base_url+"inventory/ajax_search_dispense",data:q,beforeSend:function(){$("#unit, #tr_qty").prop("disabled",false);$("select#unit option").detach();$("#unit").append('<option value="">- - -</option>');$("#unit, #tr_qty").prop("disabled",true)},success:function(r){if(r.status=="no"){}else{o=r[0].box;d=r[0].pcs;k=r[0].pcsper_set_x_qty;$("#tr_lot_no").attr("data-box",o);$("#unit").prop("disabled",false)}},error:function(t,s,r){e("Search Medicine - Error!","Connection problems occurred... Unable to connect to the Internet! The Internet connection has been lost. ","error",1500)}});return false}function a(){console.log("get_medicine");$("#tr_qty").val(Number($("#tr_qty1").val()));j();var q={tr_funding:$("#tr_funding").val(),tr_program:$("#tr_program").val(),medicine:""};$.ajax({dataType:"json",type:"GET",url:base_url+"inventory/ajax_search_dispense",data:q,beforeSend:function(){$("#medicine").append('<option value="">loading...</option>')},success:function(r){$("#medicine option").detach();if(r.status=="no"){$("sup.r").text("No Available Stock");$("#mdl-popup .modal-body p:eq(0) span").text($(".c-disabled").text());$("#mdl-popup .modal-body p:eq(1) span").text($("#tr_funding").val());$("#mdl-popup .modal-body p:eq(2) span").text($("#tr_program").val());$("#mdl-popup").modal("show");$("#tr_lot_no option, #unit option").detach();$("#tr_lot_no, #unit").append('<option value="">- - -</option>');$("#medicine, #tr_lot_no, #unit, #tr_qty").prop("disabled",true)}else{$("sup.r").text("");$("#medicine").prop("disabled",false);$.each(r,function(t,s){if(s.pcsper_set_x_qty!=0){$("#medicine").append("<option value="+s.m_id+" data-m_name='"+s.m_name+"' data-tr_si_no='"+s.tr_si_no+"' data-tr_dr_no='"+s.tr_dr_no+"' data-tr_supplier='"+s.tr_supplier+"'>"+s.m_name+"</option>")}});$("#medicine").val(null).trigger("change")}},error:function(t,s,r){e("Search Medicine - Error!","Connection problems occurred... Unable to connect to the Internet! The Internet connection has been lost. ","error",1500)}});return false}function f(){console.log("get_lotno");$("#tr_qty").val(Number($("#tr_qty1").val()));j();var q={tr_funding:$("#tr_funding").val(),medicine:$("#medicine").val(),tr_program:$("#tr_program").val(),tr_lot_no:""};$.ajax({dataType:"json",type:"GET",url:base_url+"inventory/ajax_search_dispense",data:q,beforeSend:function(){$("#tr_lot_no option").detach();$("#tr_lot_no").append('<option value="">loading...</option>');$("#tr_lot_no, #unit, #tr_qty").prop("disabled",true)},success:function(r){if(r.status=="no"){$("#tr_qty").prop("disabled",true)}else{$("#tr_lot_no").prop("disabled",false);$("#tr_lot_no option").detach();$("#tr_lot_no").append('<option value="">- - -</option>');$("#tr_lot_no").prop("disabled",false);$.each(r,function(u,t){if(t.pcsper_set_x_qty!=0){var v=new Date(t.tr_expiration_date),y=v.getDate(),A=v.getMonth()+1,s=v.getFullYear(),w=s.toString().substring(2,4);$("#tr_lot_no").append("<option value='"+t.tr_lot_no+"' data-m_name='"+t.m_name+"' data-m_set='"+t.m_set+"' data-pcsper_set="+t.m_pcsper_set+" data-program='"+t.tr_program+"' data-expirationdate='"+t.tr_expiration_date+"' style='color:"+t.remarks+"'>"+t.tr_lot_no+" ["+A+"."+y+"."+w+"]</option>");var B=$("input[name^='vlotno']").length,x=$("input[name^='vlotno']");for(i=0;i<B;i++){var z=x.eq(i).attr("value");$("#tr_lot_no option[value='"+z+"']").remove()}}})}},error:function(t,s,r){e("Search LotNo. - Error!","Connection problems occurred... Unable to connect to the Internet! The Internet connection has been lost. ","error",1500)}});return false}$("select#unit").focus(function(){var q=$("#tr_lot_no").find("option:selected");var r=q.data("m_set"),s=q.data("pcsper_set"),t=$("#tr_lot_no").attr("data-box");$("select#unit option").detach();if(q.val()!=""){$("#unit").append('<option value="">- - -</option>');if(t!="0"){$("select#unit").append('<option value="'+s+'" data-val="'+r+" ["+s+']" data-unit="'+r+'">'+r+" ["+s+"]</option>")}if(s!=1){$("select#unit").append('<option value="1" data-val="PC [1]" data-unit="PC">PC [1]</option>')}}});$("select#unit").change(function(){$("#tr_qty1, #tr_qty").val("");var q=$(this).find("option:selected"),r=q.data("unit");if(q.val()!=""){$("#tr_qty").prop("disabled",false);if(r=="PC"){if(k=="0"){$("#tr_qty1").val("0");$("span.remarks").html("0")}else{$("#tr_qty1").val(k);$("span.remarks").html(" ["+k+" PC/s]")}}else{if(o=="0"){if(d=="0"){$("#tr_qty1").val("0");$("span.remarks").html("0")}else{$("#tr_qty1").val(d);$("span.remarks").html(" ["+d+" PC/s]")}}else{$("#tr_qty1").val(o);if(d=="0"){$("span.remarks").html(" ["+o+" "+r+"/es ]")}else{$("span.remarks").html(" ["+o+" "+r+"/es & "+d+" PC/s]")}}}}else{$("span.remarks").html("");$("#tr_qty").prop("disabled",true)}});$("#frm_dispense").formValidation({framework:"bootstrap",icon:null,fields:{tr_allocateby:{validators:{regexp:{regexp:/^[0-9a-zA-Z .,-]+$/i}}},tr_by:{validators:{regexp:{regexp:/^[0-9a-zA-Z .,-]+$/i}}},tr_fname:{validators:{regexp:{regexp:/^[0-9a-zA-Z .,-]+$/i}}},tr_lname:{validators:{regexp:{regexp:/^[0-9a-zA-Z .,-]+$/i}}},tr_mname:{validators:{regexp:{regexp:/^[0-9a-zA-Z .,-]+$/i}}},tr_rs_no:{validators:{regexp:{regexp:/^[0-9a-zA-Z.,-]+$/i,}}},tr_fc_id:{validators:{regexp:{regexp:/^[0-9a-zA-Z.,-]+$/i,}}},tr_sc_id:{validators:{regexp:{regexp:/^[0-9a-zA-Z.,-]+$/i,}}},tr_qty:{validators:{lessThan:{value:"tr_qty1",message:"The value must be less than or equal to Qty [ - -]"}}},tr_date:{validators:{date:{format:"YYYY-MM-DD",message:"The value is not a valid date"}}}}}).on("success.form.fv",function(w){if($(".tbl-medicine-container #tbl_medicine tbody > tr .m-delete").length==0){e("Required *","Please add medicine","",1500);return false}w.preventDefault();var s=$(w.target),u=s.data("formValidation").getSubmitButton();switch(u.attr("id")){case"btn_frm_dispense":$("#tr_funding, #tr_program").prop("disabled",false);$("#mdl-save-draft .btn-close").trigger("click");var q=new Date(),r=("0"+(q.getMonth()+1)).slice(-2),v=q.getFullYear().toString().substr(2,2);q="D-"+v+""+r;var t={format:q};$.ajax({dataType:"json",type:"GET",url:base_url+"inventory/ajax_search_risno",data:t,beforeSend:function(){e("Processing","Please wait..","info",999999)},success:function(x){$(".alert-info .glyphicon-remove").trigger("click");if(x.status=="no"){$("#tr_rs_no").val(q+"-0001")}else{$("#tr_rs_no").val(q+"-"+x[0].series)}$.ajax({dataType:"json",type:"post",url:base_url+"inventory/ajax_savedispense",data:$("#frm_dispense").serialize(),beforeSend:function(){e("Processing","Please wait..","info",999999)},success:function(y){$(".alert-info .glyphicon-remove").trigger("click");if(y.status=="yes"){e("Success!",y.content,"success",1500);$("#tr_type").val("WALK-IN");p();$("#mdl-print").modal("show")}else{e("Failed!",y.content,"",1500);g()}},error:function(A,z,y){$(".alert-info .glyphicon-remove").trigger("click");if(A.responseText.indexOf("1062")!=-1){e("Duplicate entry!","This medicine is already exists!, Please check.","error",1500)}else{e("Error!","Connection problems occurred... Unable to connect to the Internet! The Internet connection has been lost.","error",1500)}g()}})},error:function(z,y,x){$(".alert-info .glyphicon-remove").trigger("click");e("Error!","Connection problems occurred... Unable to connect to the Internet! The Internet connection has been lost.","error",1500);g()}});break;case"draftButton":$("#mdl-save-draft .modal-body p:eq(0)").text($("#tr_funding").val());$("#mdl-save-draft .modal-body p:eq(1)").text($("#tr_program").find("option:selected").text());$("#mdl-save-draft .modal-body p:eq(2)").text($("#tr_fc_id").val());$("#mdl-save-draft .modal-body p:eq(3)").text($("#tr_sc_id").val());$("#mdl-save-draft .modal-body p:eq(4)").text($("#tr_fname").val()+" "+$("#tr_mname").val()+" "+$("#tr_lname").val());$("#mdl-save-draft .modal-body p:eq(5)").text($("#tr_type").val());$("#mdl-save-draft .modal-body p:eq(6)").text($("#tr_brgy").val());$("#mdl-save-draft .modal-body p:eq(7)").text($("#tr_by").val());$("#mdl-save-draft .modal-body p:eq(8)").text($("#tr_date").val());$("#mdl-save-draft .modal-body p:eq(9)").text($("#tr_rs_no").val());$("#mdl-save-draft .draft-table").empty();$("#tbl_medicine").clone().appendTo("#mdl-save-draft .modal-body .draft-table");$(".draft-table #tbl_medicine input").removeAttr("name");$(".draft-table #tbl_medicine input").removeAttr("id");s.data("formValidation").disableSubmitButtons(false);if($("#tr_type").val()=="CITY-EMPLOYEE"){$(".mlbl-bgry").html("Department <span>*</span>")}else{$(".mlbl-bgry").html("Brgy <span>*</span>")}$("#mdl-save-draft").modal("show");break}return false});$("body").delegate("#btn_add_medicine","click",function(){if($("select#medicine").val()==""||$("select#medicine").val()==null){e("Required *","Please select medicine","",1500);$("select#medicine").focus();$form.data("formValidation").disableSubmitButtons(false);return false}if($("select#tr_lot_no").val()==""){e("Required *","Please select lot no.","",1500);$("select#tr_lot_no").focus();$form.data("formValidation").disableSubmitButtons(false);return false}if($("select#unit").val()==""){e("Required *","Please select package","",1500);$("select#unit").focus();$form.data("formValidation").disableSubmitButtons(false);return false}if($("#tr_qty").val()=="0"||$("#tr_qty").val()==""||$(".form-group-add").hasClass("has-error")){e("Required *","Please check the qty","",1500);$("#tr_qty").focus();$form.data("formValidation").disableSubmitButtons(false);return false}$("#tbl_medicine").removeClass("display-none");var v=$("select#medicine").find("option:selected"),y=v.data("m_name"),r=v.data("tr_si_no"),F=v.data("tr_dr_no"),A=v.data("tr_supplier");var s=$("select#tr_lot_no").find("option:selected"),t=s.val();var C=$("select#unit").find("option:selected"),B=C.data("val"),E=C.data("unit"),x=C.val(),q=$("#tr_qty").val();var w=$("select#tr_lot_no").find("option:selected"),D=w.data("program"),z=w.data("expirationdate");$("#tr_qty1").val(Number($("#tr_qty1").val())-Number(q));var u=$('<tr><td class="m-delete text-center" data-qty="'+q+'"><a class="close-link"><i class="fa fa-close"></i></a></td><td><input type="hidden" name="vmedicine[]" data-name="'+y+'" value="'+$("select#medicine").val()+'"/>'+y+'</td><td><input type="hidden" name="m_tr_si_no[]" value="'+r+'"/><input type="hidden" name="m_tr_dr_no[]" value="'+F+'"/><input type="hidden" name="m_tr_supplier[]" value="'+A+'"/><input type="hidden" name="vexpirationdate[]" value="'+z+'"/><input type="hidden" name="vlotno[]" value="'+t+'"/>'+t+'</td><td><input type="hidden" name="vunit[]" value="'+E+'"/><input type="hidden" name="vpcsper_set[]" value="'+x+'"/>'+B+'</td><td class="text-right"><input type="hidden" name="vqty[]" value="'+q+'"/>'+q+"</td></tr>");$("#tbl_medicine").append(u);$("#unit").val("").trigger("change");$(".form-group-add").removeClass("has-success");$(".form-group-add").removeClass("has-error");$("#tr_qty").val("");$("#tr_location, #tr_funding, #tr_program").prop("disabled",true);$("#btn_cancel_trans").removeClass("hidden");$("#tr_lot_no").find("option:selected").remove()});$("body").delegate(".m-delete","click",function(){$("#tr_qty1").val(Number($(this).data("qty"))+Number($("#tr_qty1").val()));$(this).parent().remove();$("#medicine").val(null).trigger("change")});$("body").delegate("#btn_cancel_trans","click",function(){$("#tr_funding, #tr_program").prop("disabled",false);$("#tr_funding").val("");$("#tr_program").val("N/A");$("#btn_cancel_trans").addClass("hidden");$("#frm_dispense").data("formValidation").resetForm();$("#medicine, #tr_lot_no, #unit, #tr_qty").prop("disabled",true);$("#tbl_medicine").addClass("display-none");$("#tbl_medicine tbody").detach();$("span.remarks").html("");j()});$("body").delegate("#btn_cancel","click",function(){g();$("#tr_type").val("WALK-IN");p()});function e(q,s,t,r){new PNotify({title:q,text:s,styling:"bootstrap3",type:t,delay:r})}function g(){$("#btn_cancel_trans").addClass("hidden");$("#tr_location, #tr_funding, #tr_program").prop("disabled",false);$("#frm_dispense").data("formValidation").resetForm();$("#frm_dispense")[0].reset();$("#medicine, #tr_lot_no, #unit, #tr_qty").prop("disabled",true);$("#tbl_medicine").addClass("display-none");$("#tbl_medicine tbody").detach();$("span.remarks").html("");j()}function j(){o=0;d=0;k=0;$("#tr_qty, #unit, #tr_qty1").val("");$("span.remarks").html("")}function c(r,q,s,u){var t=new XMLHttpRequest();t.open("GET",r,true);t.onreadystatechange=function(){if(this.readyState==4&&this.status==200){var v=JSON.parse(this.responseText);$(q).detach();if(u==0){$(s).append('<option value="">- - -</option>')}else{$(s).append("<option value='N/A'>N/A</option>")}for(i=0;i<v.length;i++){$(s).append("<option value='"+v[i].value+"'>"+v[i].value+"</option>")}$(s).prop("disabled",false)}};t.send()}c(base_url+"admin/ajax_get_tr_funding","#tr_funding option","#tr_funding",0);c(base_url+"admin/ajax_get_program","#tr_program option","#tr_program",1);$("body").delegate("#btn_cancel_print","click",function(){g()});$("body").delegate("#btn_print","click",function(){$(".glyphicon-remove").trigger("click");$("span.source").text($("#lbl-location").text());$("span.destination").text($("#tr_fname").val()+" "+$("#tr_lname").val());var q=new Date($("#tr_date").val().split("-")),t=q.getDate(),z=q.getMonth()+1,r=q.getFullYear();q=z+"/"+t+"/"+r;$("span.date").text(q);$("span.tr_allocateby").text($("#tr_by").val());$("div.p_risno").text($("#tr_rs_no").val());var y=$("input[name^='vmedicine']").length,w=$("input[name^='vmedicine']"),v=$("input[name^='vlotno']"),x=$("input[name^='vunit']"),s=$("input[name^='vpcsper_set']"),u=$("input[name^='vqty']");vexpirationdate=$("input[name^='vexpirationdate']");$("#tbl-print .t-detach").detach();for(i=0;i<y;i++){var q=new Date(vexpirationdate.eq(i).attr("value").split("-")),t=q.getDate(),z=q.getMonth()+1,r=q.getFullYear();q=z+"/"+t+"/"+r;$("#tbl-print tr.title").after("<tr class='t-detach'><td>&nbsp; "+q+"</td><td colspan='2'> &nbsp;"+w.eq(i).attr("data-name")+" ["+v.eq(i).attr("value")+"]</td><td>&nbsp; "+s.eq(i).attr("value")+" ["+x.eq(i).attr("value")+"]</td><td class='text-right'>"+u.eq(i).attr("value")+"&nbsp;</td><td colspan='2'></td></tr>")}$("#mdl-previewprint").modal("show");g()})});function printContent(b){var a=document.getElementById(b);newWin=window.open("");newWin.document.write("<html><head><style>table{width:100%}b, strong {font-weight:700}table {border-collapse:collapse;}table td, table th{ border: 1px solid black; text-align:left;}tr.group{background-color: #d8d8d8;margin-top:10px;padding-top:10px} .img-logo {position:absolute;left:calc(50% - 200px);top:11px}.th-head{position:relative;padding:10px 0}p.p-version{position:absolute;top:0;right:3px;font-size:9px}.version{position:relative}.p_risno{position:absolute;right:6px;top:3px}.text-right{text-align:right}</style>");newWin.document.write('</head><body onload="window.print()">');newWin.document.write(a.outerHTML);newWin.document.write("</body>");newWin.document.write("</html>");newWin.print();newWin.close()};