$(function(){var e=$("#medicine"),d=$("select#unit"),f=$("#frm_in"),g=$("body"),h=$("#tbl_medicine"),j=$("#tr_lot_no");d=$("#unit"),$tr_qty=$("#tr_qty"),$tr_expiration_date=$("#tr_expiration_date"),$form_group_add=$(".form-group-add"),h=$("#tbl_medicine");$("#tr_date, #tr_expiration_date").inputmask("9999-99-99",{placeholder:"yyyy-mm-dd"});j.on("keyup",function(l){if($(this).val().toUpperCase()=="N/A"){$tr_expiration_date.prop("disabled",true)}else{$tr_expiration_date.prop("disabled",false)}});var b="",k=new XMLHttpRequest();k.open("GET",base_url+"inventory/ajax_get_medicine",true);k.onreadystatechange=function(){if(this.readyState==4&&this.status==200){var l=JSON.parse(this.responseText);$("#medicine option").detach();b+='<option value="">- - -</option>';for(i=0;i<l.length;i++){b+="<option value="+l[i].m_id+" data-m_name='"+l[i].m_name+"' data-set="+l[i].m_set+" data-pcsper_set="+l[i].m_pcsper_set+">"+l[i].m_name+"</option>"}e.html(b);e.prop("disabled",false)}};k.send();e.change(function(){j.val("");var o=$(this).find("option:selected"),n=o.data("set"),l=o.data("pcsper_set"),m="";$("select#unit option").detach();m+='<option value="">- - -</option>';m+='<option value="'+l+'" data-val="'+n+" ["+l+']" data-unit="'+n+'">'+n+" ["+l+"]</option>";if(l!=1){m+='<option value="1" data-val="PC [1]" data-unit="PC">PC [1]</option>'}d.html(m)});f.formValidation({framework:"bootstrap",icon:null,fields:{tr_by:{validators:{regexp:{regexp:/^[0-9a-zA-Z .,-]+$/i,}}},tr_si_no:{validators:{regexp:{regexp:/^[0-9a-zA-Z-.]+$/i,}}},tr_lot_no:{validators:{regexp:{regexp:/^[0-9a-zA-Z-/]+$/i,},stringLength:{max:20},}},tr_dr_no:{validators:{regexp:{regexp:/^[0-9a-zA-Z-.]+$/i,}}},tr_supplier:{validators:{regexp:{regexp:/^[0-9a-zA-Z .,-]+$/i,}}},tr_qty:{validators:{integer:{message:"The value is not number"}}},tr_expiration_date:{validators:{date:{format:"YYYY-MM-DD",message:"The value is not a valid date"}}},tr_date:{validators:{date:{format:"YYYY-MM-DD",message:"The value is not a valid date"}}}}}).on("success.form.fv",function(n,o){if($(".tbl-medicine-container #tbl_medicine tbody > tr .m-delete").length==0){c("Required *","Please add medicine","",1500);return false}n.preventDefault();var m=$(n.target),q=m.data("formValidation").getSubmitButton();switch(q.attr("id")){case"btn_frm_in":$("#mdl-save-draft .btn-close").trigger("click");var s="",r=new Date(),l=("0"+(r.getMonth()+1)).slice(-2),p=r.getFullYear().toString().substr(2,2);r="I-"+p+""+l;var t={format:r};$.ajax({dataType:"json",type:"GET",url:base_url+"inventory/ajax_search_risno",data:t,beforeSend:function(){c("Processing","Please wait..","info",999999)},success:function(u){$(".alert-info .glyphicon-remove").trigger("click");if(u.status=="no"){s=r+"-0001"}else{s=r+"-"+u[0].series}$.ajax({dataType:"json",type:"post",url:base_url+"inventory/ajax_savein",data:f.serialize()+"&tr_rs_no="+s,beforeSend:function(){c("Processing","Please wait..","info",90000)},success:function(v){$(".alert-info .glyphicon-remove").trigger("click");if(v.status=="yes"){c("Success!",v.content,"success",1500);a()}else{c("Failed!",v.content,"",3000);a()}},error:function(w,x,v){if(w.responseText.indexOf("1062")!=-1){c("Duplicate entry!","This medicine is already exists!, Please check.","error",2000)}else{c("Error!","Connection problems occurred... Unable to connect to the Internet! The Internet connection has been lost.","error",1500)}a()}})},error:function(v,w,u){$(".alert-info .glyphicon-remove").trigger("click");c("Error!","Connection problems occurred... Unable to connect to the Internet! The Internet connection has been lost.","error",1500);a()}});break;case"draftButton":$("#mdl-save-draft .modal-body p:eq(0)").text($("#tr_location").val());$("#mdl-save-draft .modal-body p:eq(1)").text($("#tr_funding").val());$("#mdl-save-draft .modal-body p:eq(2)").text($("#tr_program").val());$("#mdl-save-draft .modal-body p:eq(3)").text($("#tr_si_no").val());$("#mdl-save-draft .modal-body p:eq(4)").text($("#tr_dr_no").val());$("#mdl-save-draft .modal-body p:eq(5)").text($("#tr_supplier").val());$("#mdl-save-draft .modal-body p:eq(6)").text($("#tr_by").val());$("#mdl-save-draft .modal-body p:eq(7)").text($("#tr_date").val());$("#mdl-save-draft .draft-table").empty();h.clone().appendTo("#mdl-save-draft .modal-body .draft-table");$(".draft-table #tbl_medicine input").removeAttr("name");$(".draft-table #tbl_medicine input").removeAttr("id");m.data("formValidation").disableSubmitButtons(false);$("#mdl-save-draft").modal("show");break}return false});g.delegate("#btn_add_medicine","click",function(){if(e.val()==""||e.val()==null){c("Required *","Please select medicine","",1500);e.focus();return false}if(j.val()==""){c("Required *","Please select lot no","",1500);j.focus();return false}if(d.val()==""){c("Required *","Please select package","",1500);d.focus();return false}if($tr_qty.val()==""||$form_group_add.hasClass("has-error")){c("Required *","Please input qty","",1500);$tr_qty.focus();return false}h.removeClass("display-none");var q=e.find("option:selected");var u=q.data("m_name");var y=d.find("option:selected");var l=y.data("val");var o=y.data("unit");var z=y.val();var v=document.getElementById("tbl_medicine");var p=v.rows.length;for(var n=0;n<p;n+=1){if($("#tbl_medicine input[name='vmedicine[]']").length){var x=$("input[name='vmedicine[]']").map(function(){return $(this).val()}).get();var s=$("input[name='vlotno[]']").map(function(){return $(this).val()}).get();var t=$("input[name='vexpdate[]']").map(function(){return $(this).val()}).get();var w=$("input[name='vunit[]']").map(function(){return $(this).val()}).get();var r=$("input[name='vqty[]']").map(function(){return $(this).val()}).get();if(jQuery.inArray(e.val(),x)!=-1&&jQuery.inArray(j.val(),s)!=-1&&jQuery.inArray($tr_expiration_date.val(),t)!=-1&&jQuery.inArray(o,w)!=-1&&jQuery.inArray($tr_qty.val(),r)!=-1){if($("body .ui-pnotify > .alert-danger").length==0){c("Duplicate entry!","You have entered medicine that already exists. Please check!","error",2500)}return false}}}var m=$('<tr><td class="m-delete text-center"><a class="close-link"><i class="fa fa-close"></i></a></td><td><input type="hidden" name="vmedicine[]" value="'+e.val()+'"/>'+u+'</td><td><input type="hidden" name="vlotno[]" value="'+j.val()+'"/>'+j.val()+'</td><td><input type="hidden" name="vexpdate[]" value="'+$tr_expiration_date.val()+'" />'+$tr_expiration_date.val()+'</td><td><input type="hidden" name="vunit[]" value="'+o+'"/><input type="hidden" name="vpcsper_set[]" value="'+z+'"/>'+l+'</td><td class="text-right"><input type="hidden" name="vqty[]" value="'+$tr_qty.val()+'"/>'+$tr_qty.val()+"</td></tr>");h.append(m);$form_group_add.removeClass("has-success");$form_group_add.removeClass("has-error");$tr_qty.val("");d.val("").trigger("change")});g.delegate(".m-delete","click",function(){$(this).parent().remove()});g.delegate("#btn_cancel","click",function(){a()});function c(m,l,o,n){new PNotify({title:m,text:l,styling:"bootstrap3",type:o,delay:n})}function a(){e.val(null).trigger("change");f.data("formValidation").resetForm();f[0].reset();h.addClass("display-none");$("#tbl_medicine tbody").detach();$("select#unit option").detach();d.append('<option value="">- - -</option>')}});